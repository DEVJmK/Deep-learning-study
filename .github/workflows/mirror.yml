name: Mirror with Keep Workflow

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  mirror-and-keep:
    runs-on: ubuntu-latest
    steps:
      # 1. 현재 내 레포지토리를 먼저 받아서 mirror.yml 파일을 확보
      - name: Checkout current repo
        uses: actions/checkout@v3

      # 2. mirror.yml 파일을 잠시 안전한 곳(/tmp)으로 피신시킴
      - name: Backup workflow file
        run: |
          mkdir -p /tmp/backup
          cp .github/workflows/mirror.yml /tmp/backup/mirror.yml

      # 3. 원본(Upstream) 데이터 가져와서 덮어쓰기
      - name: Sync from Upstream
        env:
          UPSTREAM_REPO: "https://github.com/StatDLArchive/Deep-Learning.git"
          # ⚠️ 주의: 원본 레포의 메인 브랜치가 master라면 아래 main을 master로 바꿔주세요!
          UPSTREAM_BRANCH: "main" 
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # 원본 리포지토리 연결 및 데이터 가져오기
          git remote add upstream "$UPSTREAM_REPO"
          git fetch upstream

          # 내 레포를 원본 상태로 강제 초기화 (이때 파일들이 다 원본 걸로 바뀜)
          git reset --hard upstream/$UPSTREAM_BRANCH

      # 4. 아까 피신시킨 mirror.yml 파일을 다시 복구
      - name: Restore workflow file
        run: |
          mkdir -p .github/workflows
          cp /tmp/backup/mirror.yml .github/workflows/mirror.yml

      # 5. 복구된 파일을 포함해서 강제 푸시
      - name: Push changes
        run: |
          git add .github/workflows/mirror.yml
          git commit -m "Sync upstream and keep mirror.yml"
          git push -f origin main
